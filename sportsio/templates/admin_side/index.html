{% extends 'admin_side/base.html' %}

{% block content %}
{% load static %}
<style>
    /* Style the dropdown options */
  #time-interval {
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
  }
  
  #time-interval option {
      padding: 5px 10px;
      background-color: #f8f8f8;
      color: #333;
      font-size: 16px;
      border: none;
  }
  
  #time-interval option:hover {
      background-color: #e0e0e0;
  }
  .chart-container {
    width: 300px;
    height: 300px;
    margin: 36px 26px 7px 434px;
  }
  
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <div class="container">
    <div class="row">
      <div class="col-xl-3 col-lg-3">
        <div class="card l-bg-cherry">
            <div class="card-statistic-3 p-4">
                <div class="card-icon card-icon-large"><i class="fas fa-shopping-cart"></i></div>
                <div class="mb-4">
                    <h5 class="card-title mb-0">New Orders</h5>
                </div>
                <div class="row align-items-center mb-2 d-flex">
                    <div class="col-8">
                        <h2 class="d-flex align-items-center mb-0">
                            {{ total_orders }}
                        </h2>
                    </div>
                    <div class="col-4 text-right">
                        <span class="text-success">+{{ total_orders_last_week }}<i class="fa fa-arrow-up"></i></span>
                    </div>
                </div>
                <div class="progress mt-1 " data-height="8" style="height: 8px;">
                    <div class="progress-bar l-bg-cyan" role="progressbar" data-width="25%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100" style="width: 25%;"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-lg-3">
        <div class="card l-bg-blue-dark">
            <div class="card-statistic-3 p-4">
                <div class="card-icon card-icon-large"><i class="fas fa-users"></i></div>
                <div class="mb-4">
                    <h5 class="card-title mb-0">Customers</h5>
                </div>
                <div class="row align-items-center mb-2 d-flex">
                    <div class="col-8">
                        <h2 class="d-flex align-items-center mb-0">
                            {{ total_customers }}
                        </h2>
                    </div>
                    <div class="col-4 text-right">
                        <span>{{ new_users_last_week }}% <i class="fa fa-arrow-up"></i></span>
                    </div>
                </div>
                <div class="progress mt-1 " data-height="8" style="height: 8px;">
                    <div class="progress-bar l-bg-green" role="progressbar" data-width="25%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100" style="width: 25%;"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-lg-3">
        <div class="card l-bg-green-dark">
            <div class="card-statistic-3 p-4">
                <div class="card-icon card-icon-large"><i class="fas fa-ticket-alt"></i></div>
                <div class="mb-4">
                    <h5 class="card-title mb-0">Total Products</h5>
                </div>
                <div class="row align-items-center mb-2 d-flex">
                    <div class="col-8">
                        <h2 class="d-flex align-items-center mb-0">
                            {{ total_products }}
                        </h2>
                    </div>
                    <div class="col-4 text-right">
                        <span>10% <i class="fa fa-arrow-up"></i></span>
                    </div>
                </div>
                <div class="progress mt-1 " data-height="8" style="height: 8px;">
                    <div class="progress-bar l-bg-orange" role="progressbar" data-width="25%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100" style="width: 25%;"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-lg-3">
        <div class="card l-bg-orange-dark">
            <div class="card-statistic-3 p-4">
                <div class="card-icon card-icon-large"><i class="fas fa-dollar-sign"></i></div>
                <div class="mb-4">
                    <h5 class="card-title mb-0">Total Revenue </h5>
                </div>
                <div class="row align-items-center mb-2 d-flex">
                    <div class="col-8">
                        <h2 class="d-flex align-items-center mb-0">
                            â‚¹{{ total_amount_received }}k
                        </h2>
                    </div>
                    <div class="col-4 text-right">
                        <span><i class="fa fa-arrow-up"> {{ total_amount_received_last_week }}k</i></span>
                    </div>
                </div>
                <div class="progress mt-1 " data-height="8" style="height: 8px;">
                    <div class="progress-bar l-bg-cyan" role="progressbar" data-width="25%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100" style="width: 25%;"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
      <div class="content">
        <h3> Filter the sales report </h3>
    
        <!-- Add this code within the form tag or wherever you want to place the date inputs and button -->
    <div class="row mb-3">
        <label class="col-sm-2 col-form-label" for="from-date">From:</label>
        <div class="col-sm-3">
            <input type="date" class="form-control" id="from-date" name="from_date">
        </div>
    </div>
    <div class="row mb-3">
        <label class="col-sm-2 col-form-label" for="to-date">To:</label>
        <div class="col-sm-3">
            <input type="date" class="form-control" id="to-date" name="to_date">
        </div>
    </div>
    <button id="filter-sales-btn" class="btn btn-primary ml-2">Filter Sales</button>
    
    <!-- Add this script at the end of your HTML template -->
    <script>
        // JavaScript to handle the button click event for filtered sales report
        document.getElementById('filter-sales-btn').addEventListener('click', function(event) {
            event.preventDefault(); 
            const fromDateInput = document.getElementById('from-date');
            const toDateInput = document.getElementById('to-date');
            console.log(`${fromDateInput} from date`)
            console.log(`${toDateInput} toDateInput`)
            
            // Get the current date
            const currentDate = new Date().toISOString().split('T')[0];
            console.log(`${currentDate} currentDate`)
    
            // Get the selected dates from the inputs
            const fromDate = fromDateInput.value;
            const toDate = toDateInput.value;
            console.log(`${fromDate} fromDate`)
            console.log(`${toDate} toDate`)
            // Check if the selected dates are in the future
            if (fromDate > currentDate || toDate > currentDate) {
                alert("Please enter a valid date.");
                return; // Prevent further execution

            }
    
            // Redirect to the same page with query parameters for filtered sales report
            window.location.href = `?from_date=${fromDate}&to_date=${toDate}`;
            console.log(window.location.href)
        });
    </script>
    
    
    <div class="mt-4">
      <canvas id="myChart" class="chart-canvas" width="200" height="100"></canvas>
  </div>
  
  
  <style>
  .chart-container {
    width: 300px;
    height: 300px;
  }
  </style>
  
  <div class="chart-container">
    <canvas id="donut" width="300" height="300"></canvas>
  </div>
  <div class="container-fluid">
    <!-- Row 1 -->
    <div class="row">
      <div class="col-lg-4 d-flex align-items-stretch">
          <div class="card w-100">
              <div class="card-body p-4">
                  <div class="mb-4">
                      <h5 class="card-title fw-semibold">Top Products</h5>
                  </div>
                  <div class="table-responsive">
                      <table class="table table-striped">
                          <thead>
                              <tr>
                                  <th>Orders Count</th>
                                  <th>Product Name</th>
                                  <th>Product Manufacturer</th>
                              </tr>
                          </thead>
                          <tbody>
                              {% for product in top_products %}
                              <tr>
                                  <td>{{ product.total_orders}}</td>
                                  <td>{{ product.title|truncatewords:5 }}</td>
                                  <td>{{ product.brand }}</td>
                              </tr>
                              {% endfor %}
                          </tbody>
                      </table>
                  </div>
              </div>
          </div>
      </div>
      
      <div class="col-lg-4 d-flex align-items-stretch">
        <div class="card w-100">
            <div class="card-body p-4">
                <div class="mb-4">
                    <h5 class="card-title fw-semibold">Top Brands</h5>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Brand Name</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for brand in top_brands %}
                            <tr>
                                <td>{{ brand.brand_name }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4 d-flex align-items-stretch">
      <div class="card w-100">
          <div class="card-body p-4">
              <div class="mb-4">
                  <h5 class="card-title fw-semibold">Top Categories</h5>
              </div>
              <div class="table-responsive">
                  <table class="table table-striped">
                      <thead>
                          <tr>
                              <th>Category Name</th>
                          </tr>
                      </thead>
                      <tbody>
                          {% for category in top_categories %}
                          <tr>
                              <td>{{ category.name }}</td>
                          </tr>
                          {% endfor %}
                      </tbody>
                  </table>
              </div>
          </div>
      </div>
  </div>
  </div>
  </div>
  
      
  </div>
    <div class="row">
      <div class="col-lg-4">
        <div class="row">
          <div class="col-lg-12">
            <!-- Yearly Breakup -->
            <div class="card overflow-hidden">
                <div class="card-body p-4">
                    <h5 class="card-title mb-9 fw-semibold">Yearly Breakup</h5>
                    <div class="row align-items-center">
                        <div class="col-8">
                            <!-- Display yearly revenue -->
                            {% for revenue in yearly_revenue %}
                            <h4 class="fw-semibold mb-3">&#8377;{{ revenue.total_revenue }}</h4>
                            <div class="d-flex alig-items-center mb-3">
                                <!-- You can add additional elements here if needed -->
                            </div>
                            <div class="d-flex align-items-center">
                                <div class="me-4">
                                    <span class="round-8 bg-primary rounded-circle me-2 d-inline-block"></span>
                                    <span class="fs-2">{{ revenue.year|date:"Y" }}</span>
                                </div>
                                <div>
                                    <span class="round-8 bg-light-primary rounded-circle me-2 d-inline-block"></span>
                                    <span class="fs-2">{{ revenue.year|date:"Y" }}</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <div class="col-4">
                            <div class="d-flex justify-content-center">
                                <div id="breakup"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-12">
          <!-- Monthly Earnings -->
          <div class="card">
              <div class="card-body">
                  <div class="row align-items-start">
                      <div class="col-8">
                          <h5 class="card-title mb-9 fw-semibold"> Monthly Earnings </h5>
                          <!-- Display monthly revenue -->
                          {% for revenue in monthly_revenue %}
                          <h4 class="fw-semibold mb-3">&#8377;{{ revenue.total_revenue }}</h4>
                          <div class="d-flex align-items-center pb-1">
                              <!-- You can add additional elements here if needed -->
                          </div>
                          {% endfor %}
                      </div>
                      <div class="col-4">
                          <div class="d-flex justify-content-end">
                              <div class="text-white bg-secondary rounded-circle p-6 d-flex align-items-center justify-content-center">
                                  <i class="ti ti-currency-dollar fs-6"></i>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
            <div id="earning"></div>
      </div>
        </div>
      </div>
    </div>
    
  </div>
  <div class="mt-5">
    <h2>Order Report</h2>
  </div>
  
  <form action="{% url 'generate_pdf_report' %}" method="POST" onsubmit="return validateDate()">
    {% csrf_token %}
    <div class="row mb-3">
        <label class="col-sm-2 col-form-label" for="from-date">From:</label>
        <div class="col-sm-3">
            <input type="date" class="form-control" id="from-date" name="from_date">
        </div>
    </div>
    <div class="row mb-3">
        <label class="col-sm-2 col-form-label" for="to-date">To:</label>
        <div class="col-sm-3">
            <input type="date" class="form-control" id="to-date" name="to_date">
        </div>
    </div>
    <button class="btn btn-primary ml-2" type="submit">Generate Report</button>
  </form>
  
  
  
  

  <script>
  document.addEventListener("DOMContentLoaded", function () {
      // Populate yearly revenue
      var yearlyRevenue = {{ yearly_revenue.total_revenue|default:0 }};
      document.getElementById("yearly-revenue").innerText = "$" + yearlyRevenue.toFixed(2);
      // Populate monthly revenue
      var monthlyRevenue = {{ monthly_revenue.total_revenue|default:0 }};
      if (document.getElementById("monthly-revenue")) {
          document.getElementById("monthly-revenue").innerText = "$" + monthlyRevenue.toFixed(2);
      } else {
          console.error("Element with ID 'monthly-revenue' not found.");
      }
      // Render ApexCharts for yearly breakup and monthly earnings
      var breakup = {
          color: "#adb5bd",
          series: [38, 40, 25],
          labels: ["2022", "2021", "2020"],
          chart: {
              width: 180,
              type: "donut",
              fontFamily: "Plus Jakarta Sans', sans-serif",
              foreColor: "#adb0bb",
          },
          plotOptions: {
              pie: {
                  startAngle: 0,
                  endAngle: 360,
                  donut: {
                      size: '75%',
                  },
              },
          },
          stroke: {
              show: false,
          },
          dataLabels: {
              enabled: false,
          },
          legend: {
              show: false,
          },
          colors: ["#5D87FF", "#ecf2ff", "#F9F9FD"],
          responsive: [{
              breakpoint: 991,
              options: {
                  chart: {
                      width: 150,
                  },
              },
          }, ],
          tooltip: {
              theme: "dark",
              fillSeriesColor: false,
          },
      };
      var chart = new ApexCharts(document.querySelector("#breakup"), breakup);
      chart.render();
      var earning = {
          chart: {
              id: "sparkline3",
              type: "area",
              height: 60,
              sparkline: {
                  enabled: true,
              },
              group: "sparklines",
              fontFamily: "Plus Jakarta Sans', sans-serif",
              foreColor: "#adb0bb",
          },
          series: [{
              name: "Earnings",
              color: "#49BEFF",
              data: [25, 66, 20, 40, 12, 58, 20],
          }, ],
          stroke: {
              curve: "smooth",
              width: 2,
          },
          fill: {
              colors: ["#f3feff"],
              type: "solid",
              opacity: 0.05,
          },
          markers: {
              size: 0,
          },
          tooltip: {
              theme: "dark",
              fixed: {
                  enabled: true,
                  position: "right",
              },
              x: {
                  show: false,
              },
          },
      };
      new ApexCharts(document.querySelector("#monthly-earning"), earning).render();
  });
  </script>
  <script>
    function validateDate() {
        var fromDate = new Date(document.getElementById('from-date').value);
        var toDate = new Date(document.getElementById('to-date').value);
        var today = new Date();
  
        if (fromDate > today || toDate > today) {
            alert('Please enter a valid date.');
            return false;  // Prevent the form from submitting
        }
  
        if (fromDate > toDate) {
            alert('From date cannot be after To date.');
            return false;  // Prevent the form from submitting
        }
  
        return true;  // Allow the form to submit
    }
  </script>
  
  <script>
    // const lab = JSON.parse(`{{ labels|safe }}`);
    // const da = JSON.parse(`{{ data|safe }}`);
    
    const cx = document.getElementById('donut');
    new Chart(cx, {
    type: 'doughnut',
    data: {
    labels: JSON.parse(`{{ category_labels|safe }}`),
    datasets: [{
        label: 'Number of Products',
        data: JSON.parse(`{{ category_data|safe }}`),
        borderWidth: 1
    }]
    },
    options: {
    // Your additional options...
    }
    });
    
    </script>
    
   <script>
  const labels = JSON.parse(`{{ labels|safe }}`);
  const data = JSON.parse(`{{ data|safe }}`);
  
  const ctx = document.getElementById('myChart');
  const myChart = new Chart(ctx, {
      type: 'bar',
      data: {
          labels: labels,
          datasets: [{
              label: 'Order Amounts',
              data: data,
              borderWidth: 1
          }]
      },
      options: {
          scales: {
              y: {
                  beginAtZero: true
              }
          }
      }
  });
  
  // Listen for changes in the dropdown and reload the page with the selected time interval
  const timeIntervalDropdown = document.getElementById('time-interval');
  timeIntervalDropdown.addEventListener('change', function() {
      const selectedValue = timeIntervalDropdown.value;
      // Reload the page with the selected time interval as a query parameter
      window.location.href = `?time_interval=${selectedValue}`;
  });
  
   </script>
    
    <script>
    function filterSales(interval) {
    // Make an AJAX request to the Django view
    fetch(`/dashboard/?time_interval=${interval}`, {headers: {'X-Requested-With': 'XMLHttpRequest'}})
    .then(response => response.json())
    .then(data => {
        // Update the chart with the new data
        monthlySalesChart.data.labels = data.labels;
        monthlySalesChart.data.datasets[0].data = data.data;
        monthlySalesChart.update();
    })
    .catch(error => console.error('Error:', error));
    }
    
    const monthlyLabels = {{ monthly_labels|safe }};
    const monthlyData = {{ monthly_data|safe }};
    
    // Create a bar chart
    const x = document.getElementById('monthlySalesChart').getContext('2d');
    const monthlySalesChart = new Chart(x, {
    type: 'bar',
    data: {
    labels: monthlyLabels,
    datasets: [{
        label: 'Monthly Sales',
        data: monthlyData,
        backgroundColor: 'rgba(75, 192, 192, 0.2)',
        borderColor: 'rgba(75, 192, 192, 1)',
        borderWidth: 1
    }]
    },
    options: {
    scales: {
        y: {
            beginAtZero: true
        }
    }
    }
    });
    </script>
{% endblock %}
