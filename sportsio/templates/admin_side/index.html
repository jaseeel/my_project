{% extends 'admin_side/base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid">
  <!-- Metrics Cards -->
  <div class="row">
    <div class="col-xl-3 col-lg-3">
      <div class="card bg-primary text-white">
        <div class="card-body">
          <i class="fas fa-shopping-cart fa-3x mb-3"></i>
          <h5 class="card-title">New Orders</h5>
          <h2 class="mb-0">{{ total_order }}</h2>
          <small>Delivered: +{{ total_orders_delivered }}</small>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-lg-3">
      <div class="card bg-success text-white">
        <div class="card-body">
          <i class="fas fa-users fa-3x mb-3"></i>
          <h5 class="card-title">Customers</h5>
          <h2 class="mb-0">{{ total_customers }}</h2>
          <small>{{ new_users_last_week }}% growth</small>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-lg-3">
      <div class="card bg-info text-white">
        <div class="card-body">
          <i class="fas fa-box fa-3x mb-3"></i>
          <h5 class="card-title">Total Products</h5>
          <h2 class="mb-0">{{ total_products }}</h2>
          <small>5% growth</small>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-lg-3">
      <div class="card bg-warning text-white">
        <div class="card-body">
          <i class="fas fa-dollar-sign fa-3x mb-3"></i>
          <h5 class="card-title">Total Revenue</h5>
          <h2 class="mb-0">₹{{ total_amount }}k</h2>
          <small>Coupon Discounts: -₹{{ total_coupon_price }}k</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Sales Chart and Category Distribution -->
  <div class="row mt-4">
    <div class="col-lg-8">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Sales Report</h5>
          <div class="d-flex justify-content-between mb-3">
            <div class="w-25">
              <input type="date" id="from-date" class="form-control">
              <span id="error-from-date" class="text-danger"></span>
            </div>
            <div class="w-25">
              <input type="date" id="to-date" class="form-control">
              <span id="error-to-date" class="text-danger"></span>
            </div>
            <button id="filter-sales-btn" class="btn btn-primary">Filter</button>
          </div>
          <canvas id="myChart"></canvas>
        </div>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Category Distribution</h5>
          <canvas id="donut"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Top Products, Brands, and Categories -->
  <div class="row mt-4">
    <div class="col-lg-4">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Top Products</h5>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Orders</th>
                  <th>Product</th>
                  <th>Manufacturer</th>
                </tr>
              </thead>
              <tbody>
                {% for product in top_products %}
                <tr>
                  <td>{{ product.total_orders }}</td>
                  <td>{{ product.title|truncatewords:5 }}</td>
                  <td>{{ product.brand }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Top Brands</h5>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Brand Name</th>
                </tr>
              </thead>
              <tbody>
                {% for brand in top_brands %}
                <tr>
                  <td>{{ brand.brand_name }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Top Categories</h5>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Category Name</th>
                </tr>
              </thead>
              <tbody>
                {% for category in top_categories %}
                <tr>
                  <td>{{ category.name }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Yearly and Monthly Breakdowns -->
  <div class="row mt-4">
    <div class="col-lg-6">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Yearly Earnings</h5>
          <ul class="list-group list-group-flush">
            {% for revenue in yearly_revenue %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                {{ revenue.year|date:"Y" }}
                <span class="badge bg-primary rounded-pill">₹{{ revenue.total_revenue }}</span>
              </li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Monthly Earnings</h5>
          <ul class="list-group list-group-flush">
            {% for revenue in monthly_revenue %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                {{ revenue.month|date:"F Y" }}
                <span class="badge bg-primary rounded-pill">₹{{ revenue.total_revenue }}</span>
              </li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Report Generation -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Generate Report</h5>
          <form action="{% url 'generate_pdf_report' %}" method="POST">
            {% csrf_token %}
            <div class="row">
              <div class="col-md-2">
                <select class="form-control" name="report_type" id="report_type" required>
                  <option value="custom">Custom Date Range</option>
                  <option value="monthly">Monthly</option>
                  <option value="yearly">Yearly</option>
                </select>
              </div>
              <div class="col-md-2 custom-date">
                <input type="date" class="form-control" name="from_date" id="from_date">
              </div>
              <div class="col-md-2 custom-date">
                <input type="date" class="form-control" name="to_date" id="to_date">
              </div>
              <div class="col-md-2 period-select" style="display: none;">
                <input type="month" class="form-control" name="month" id="month">
              </div>
              <div class="col-md-2 period-select" style="display: none;">
                <input type="number" class="form-control" name="year" id="year" min="2000" max="2099" step="1" value="2024">
              </div>
              <div class="col-md-2">
                <select class="form-control" name="format" required>
                  <option value="pdf">PDF</option>
                  <option value="excel">Excel</option>
                </select>
              </div>
              <div class="col-md-2">
                <button type="submit" class="btn btn-success w-100">Generate</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Sales Chart
  const ctx = document.getElementById('myChart').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: JSON.parse('{{ labels|safe }}'),
      datasets: [{
        label: 'Order Amounts',
        data: JSON.parse('{{ data|safe }}'),
        borderWidth: 1
      }]
    },
    options: {
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });
  
  // Category Distribution Chart
  const cx = document.getElementById('donut').getContext('2d');
  new Chart(cx, {
    type: 'doughnut',
    data: {
      labels: JSON.parse('{{ category_labels|safe }}'),
      datasets: [{
        label: 'Number of Products',
        data: JSON.parse('{{ category_data|safe }}'),
        borderWidth: 1
      }]
    }
  });
  
  // Updated date validation function
  function validateDate(fromDateElement, toDateElement, fromErrorElement, toErrorElement) {
    var fromDate = new Date(fromDateElement.value);
    var toDate = new Date(toDateElement.value);
    var today = new Date();

    // Clear previous errors
    fromErrorElement.textContent = '';
    toErrorElement.textContent = '';

    // Validate From Date
    if (fromDate > today) {
      fromErrorElement.textContent = 'From date cannot be in the future.';
      return false;
    }

    // Validate To Date
    if (toDate > today) {
      toErrorElement.textContent = 'To date cannot be in the future.';
      return false;
    }

    // Additional check for From Date being earlier than To Date
    if (fromDate >= toDate) {
      fromErrorElement.textContent = 'From date must be earlier than To date.';
      return false;
    }

    return true;
  }

  // Sales filter functionality
  document.getElementById('filter-sales-btn').addEventListener('click', function(event) {
    event.preventDefault(); // Prevent form submission

    var fromDateElement = document.getElementById('from-date');
    var toDateElement = document.getElementById('to-date');
    var fromErrorElement = document.getElementById('error-from-date');
    var toErrorElement = document.getElementById('error-to-date');

    if (!validateDate(fromDateElement, toDateElement, fromErrorElement, toErrorElement)) {
      return; // Exit if validation fails
    }

    var fromDate = fromDateElement.value;
    var toDate = toDateElement.value;

    window.location.href = `?from_date=${fromDate}&to_date=${toDate}`;
  });

  // Report generation form validation
  document.addEventListener('DOMContentLoaded', function() {
    var form = document.querySelector('form[action="{% url "generate_pdf_report" %}"]');
    var reportTypeSelect = form.querySelector('#report_type');
    var customDateInputs = form.querySelectorAll('.custom-date');
    var periodSelects = form.querySelectorAll('.period-select');

    function toggleInputs() {
        if (reportTypeSelect.value === 'custom') {
            customDateInputs.forEach(input => input.style.display = 'block');
            periodSelects.forEach(select => select.style.display = 'none');
        } else {
            customDateInputs.forEach(input => input.style.display = 'none');
            periodSelects.forEach(select => select.style.display = 'block');
        }
        if (reportTypeSelect.value === 'monthly') {
            form.querySelector('#month').style.display = 'block';
            form.querySelector('#year').style.display = 'none';
        } else if (reportTypeSelect.value === 'yearly') {
            form.querySelector('#month').style.display = 'none';
            form.querySelector('#year').style.display = 'block';
        }
    }

    reportTypeSelect.addEventListener('change', toggleInputs);
    toggleInputs(); // Call once to set initial state

    form.addEventListener('submit', function(event) {
        var fromDateElement = this.querySelector('input[name="from_date"]');
        var toDateElement = this.querySelector('input[name="to_date"]');
        var fromErrorElement = document.createElement('span');
        var toErrorElement = document.createElement('span');
        fromErrorElement.className = 'text-danger';
        toErrorElement.className = 'text-danger';
        fromDateElement.parentNode.appendChild(fromErrorElement);
        toDateElement.parentNode.appendChild(toErrorElement);
        if (reportTypeSelect.value === 'custom' && !validateDate(fromDateElement, toDateElement, fromErrorElement, toErrorElement)) {
            event.preventDefault(); // Prevent form submission if validation fails
        }
    });
});
</script>
{% endblock %}