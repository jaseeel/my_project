{% extends 'admin_side/base.html' %}

{% block content %}
{% load static %}

<div class="container-fluid">
  <h2 class="mb-4">Dashboard</h2>

  <!-- Key Metrics -->
  <div class="row mb-4">
    <div class="col-xl-3 col-md-6">
      <div class="card bg-primary text-white">
        <div class="card-body">
          <h5 class="card-title">New Orders</h5>
          <h2 class="mb-0">{{ total_order }}</h2>
          <small>Delivered: +{{ total_orders_delivered }}</small>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6">
      <div class="card bg-success text-white">
        <div class="card-body">
          <h5 class="card-title">Customers</h5>
          <h2 class="mb-0">{{ total_customers }}</h2>
          <small>New: +{{ new_users_last_week }}%</small>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6">
      <div class="card bg-warning text-white">
        <div class="card-body">
          <h5 class="card-title">Total Products</h5>
          <h2 class="mb-0">{{ total_products }}</h2>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6">
      <div class="card bg-danger text-white">
        <div class="card-body">
          <h5 class="card-title">Total Revenue</h5>
          <h2 class="mb-0">₹{{ total_amount }}k</h2>
          <small>Discounts: -₹{{ total_coupon_price }}k</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts -->
  <div class="row mb-4">
    <div class="col-xl-8">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Sales Overview</h5>
          <div class="mb-3">
            <label for="time-interval" class="form-label">Filter Sales:</label>
            <select id="time-interval" class="form-select" onchange="filterSales(this.value)">
              <option value="all">All Time</option>
              <option value="monthly">This Month</option>
              <option value="yearly">This Year</option>
            </select>
          </div>
          <div style="height: 300px;">
            <canvas id="salesChart"></canvas>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-4">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Category Distribution</h5>
          <div style="height: 300px;">
            <canvas id="categoryChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Top Products and Brands -->
  <div class="row mb-4">
    <div class="col-xl-6">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Top Products</h5>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Product</th>
                  <th>Brand</th>
                  <th>Orders</th>
                </tr>
              </thead>
              <tbody>
                {% for product in top_products %}
                <tr>
                  <td>{{ product.title|truncatechars:20 }}</td>
                  <td>{{ product.brand }}</td>
                  <td>{{ product.total_orders }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-6">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Top Brands</h5>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Brand</th>
                </tr>
              </thead>
              <tbody>
                {% for brand in top_brands %}
                <tr>
                  <td>{{ brand.brand_name }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Date Filter and Report Generation -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">Generate Report</h5>
      <form action="{% url 'generate_pdf_report' %}" method="POST" onsubmit="return validateForm()">
        {% csrf_token %}
        <div class="row">
          <div class="col-md-3 mb-3">
            <label for="report-type" class="form-label">Report Type:</label>
            <select id="report-type" name="report_type" class="form-select" onchange="toggleDateInputs()">
              <option value="custom">Custom Date Range</option>
              <option value="monthly">Monthly</option>
              <option value="yearly">Yearly</option>
            </select>
          </div>
          <div id="custom-date-range">
            <div class="col-md-3 mb-3">
              <label for="from-date" class="form-label">From:</label>
              <input type="date" class="form-control" id="from-date" name="from_date">
            </div>
            <div class="col-md-3 mb-3">
              <label for="to-date" class="form-label">To:</label>
              <input type="date" class="form-control" id="to-date" name="to_date">
            </div>
          </div>
          <div id="month-select" style="display: none;">
            <div class="col-md-3 mb-3">
              <label for="month" class="form-label">Month:</label>
              <input type="month" class="form-control" id="month" name="month">
            </div>
          </div>
          <div id="year-select" style="display: none;">
            <div class="col-md-3 mb-3">
              <label for="year" class="form-label">Year:</label>
              <select id="year" name="year" class="form-select">
                {% for year in year_range %}
                  <option value="{{ year }}">{{ year }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="col-md-3 mb-3">
            <label for="format" class="form-label">Format:</label>
            <select id="format" name="format" class="form-select" required>
              <option value="pdf">PDF</option>
              <option value="excel">Excel</option>
            </select>
          </div>
          <div class="col-md-3 mb-3">
            <label class="form-label">&nbsp;</label>
            <button class="btn btn-primary w-100" type="submit">Generate Report</button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  let salesChart;

  function initSalesChart(labels, data) {
    const salesCtx = document.getElementById('salesChart').getContext('2d');
    salesChart = new Chart(salesCtx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Sales',
          data: data,
          backgroundColor: 'rgba(75, 192, 192, 0.6)',
          borderColor: 'rgb(75, 192, 192)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  }

  function updateSalesChart(labels, data) {
    salesChart.data.labels = labels;
    salesChart.data.datasets[0].data = data;
    salesChart.update();
  }

  function filterSales(interval) {
    fetch(`/dashboard/?interval=${interval}`, {
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => response.json())
    .then(data => {
      updateSalesChart(data.labels, data.data);
    })
    .catch(error => console.error('Error:', error));
  }

  initSalesChart({{ labels|safe }}, {{ data|safe }});

  const categoryCtx = document.getElementById('categoryChart').getContext('2d');
  new Chart(categoryCtx, {
    type: 'doughnut',
    data: {
      labels: {{ category_labels|safe }},
      datasets: [{
        data: {{ category_data|safe }},
        backgroundColor: [
          'rgb(255, 99, 132)',
          'rgb(54, 162, 235)',
          'rgb(255, 205, 86)',
          'rgb(75, 192, 192)',
          'rgb(153, 102, 255)'
        ]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false
    }
  });

  function toggleDateInputs() {
    const reportType = document.getElementById('report-type').value;
    const customDateRange = document.getElementById('custom-date-range');
    const monthSelect = document.getElementById('month-select');
    const yearSelect = document.getElementById('year-select');

    customDateRange.style.display = reportType === 'custom' ? 'block' : 'none';
    monthSelect.style.display = reportType === 'monthly' ? 'block' : 'none';
    yearSelect.style.display = reportType === 'yearly' ? 'block' : 'none';
  }

  function validateForm() {
    const reportType = document.getElementById('report-type').value;
    const fromDate = document.getElementById('from-date').value;
    const toDate = document.getElementById('to-date').value;
    const month = document.getElementById('month').value;
    const year = document.getElementById('year').value;

    if (reportType === 'custom' && (!fromDate || !toDate)) {
      alert('Please select both From and To dates for custom range.');
      return false;
    }

    if (reportType === 'monthly' && !month) {
      alert('Please select a month.');
      return false;
    }

    if (reportType === 'yearly' && !year) {
      alert('Please select a year.');
      return false;
    }

    return true;
  }

  toggleDateInputs();
</script>
{% endblock %}