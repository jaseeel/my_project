{% extends 'user_side/base.html' %}
{% block title %}Smart Cart | Sportsio{% endblock %}
{% block content %}
{% load humanize %}

<style>
    body {
        background: linear-gradient(100deg, #fffde7 30%, #fff9c4 60%);
        min-height: 100vh;
    }
    .cart-container {
        width: 100%;
        max-width: 1200px;
        margin: 2rem auto;
        padding: 2rem;
        background-color: rgba(255, 255, 255, 0.9);
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .cart-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 2rem;
    }
    .cart-header i {
        font-size: 1.5rem;
        margin-right: 0.5rem;
        color: #fbc02d;
    }
    .cart-content {
        display: flex;
        justify-content: space-between;
    }
    .cart-items {
        flex: 1;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
        padding-right: 1.5rem;
    }
    .cart-item {
        background-color:white;
        border-radius: 8px;
        align-items: center;
        padding: 0.75rem;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        display: flex;
        flex-direction: column;
        
    }
    .cart-item:hover {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }
    .cart-item img {
        width: 80px;
        height: 80px;
        object-fit:contain;
        border-radius: 4px;
        margin-bottom: 0.5rem;
    }
    .cart-item-details h5 {
        font-size: 0.9rem;
        margin-bottom: 0.25rem;
    }
    .cart-item-details p {
        font-size: 0.8rem;
        color: #666;
        margin-bottom: 0.15rem;
    }
    .quantity-control {
        display: flex;
        align-items: center;
        margin-top: auto;
    }
    .quantity-control button {
        background-color: #fbc02d;
        border: none;
        color: white;
        width: 24px;
        height: 24px;
        font-size: 0.8rem;
        border-radius: 50%;
        transition: background-color 0.3s ease, transform 0.1s ease;
    }
    .quantity-control button:hover {
        background-color: #f9a825;
    }
    .quantity-control button:active {
        transform: scale(0.95);
    }
    .quantity-control input {
        width: 30px;
        text-align: center;
        border: 1px solid #ced4da;
        margin: 0 0.25rem;
        border-radius: 4px;
        font-size: 0.8rem;
    }
    .cart-summary {
        width: 250px;
        background-color: white;
        padding: 1rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        align-self: flex-start;
    }
    .total-price-container {
        font-size: 1.2rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    .saved-price {
        color: #4caf50;
        font-weight: bold;
        margin-bottom: 1rem;
        font-size: 0.9rem;
    }
    .btn-checkout, .btn-continue-shopping {
        width: 100%;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        transition: background-color 0.3s ease;
        font-weight: bold;
        text-align: center;
        display: block;
        margin-bottom: 0.75rem;
        font-size: 0.9rem;
    }
    .btn-checkout {
        background-color: #fbc02d;
        color: white;
        border: none;
    }
    .btn-checkout:hover {
        background-color: #f9a825;
        text-decoration: none;
        color: white;
    }
    .btn-continue-shopping {
        background-color: white;
        color: #fbc02d;
        border: 2px solid #fbc02d;
    }
    .btn-continue-shopping:hover {
        background-color: #fef9e7;
        text-decoration: none;
        color: #f9a825;
    }
    .stocks-left {
        font-size: 0.75rem;
        color: #666;
    }
</style>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">

<div class="cart-container">
    <div class="cart-header">
        <h2 class="mb-0"><i class="fas fa-shopping-cart"></i> Your Cart</h2>
       
    </div>
    
    {% if cart %}
        <div class="cart-content">
            <div class="cart-items">
                {% for item in cart %}
                <div class="cart-item">
                    <img src="{{ item.product.image.url }}" alt="{{ item.product }}">
                    <div class="cart-item-details">
                        <h5>{{ item.product|truncatechars:20 }}</h5>
                        <p class="text-muted">₹{{ item.product.price|intcomma }}</p>
                        <p class="stocks-left">Stock: {{ item.product.stock_count }}</p>
                    </div>
                    <div class="quantity-control" data-product-id="{{ item.product.id }}">
                        <button class="minus-btn">-</button>
                        <input type="number" class="qty-input" value="{{ item.product_quantity }}" min="1" max="5" disabled>
                        <button class="plus-btn">+</button>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <div class="cart-summary">
                <div class="total-price-container">
                    Total: ₹<span class="total-price">{{ total_price|intcomma }}</span>
                </div>
                <div class="saved-price">
                    You saved: ₹<span class="saved-amount">{{ saved_price|intcomma }}</span>
                </div>
                <a href="{% url 'user_profile:order_checkout' %}" class="btn-checkout">Proceed to Checkout</a>
                <a href="{% url 'user_side:product_list' %}" class="btn-continue-shopping">Continue Shopping</a>
            </div>
        </div>
    {% else %}
        <div class="text-center py-5">
            <i class="fas fa-shopping-cart fa-4x mb-3 text-muted"></i>
            <h3>Your cart is empty</h3>
            <p class="text-muted">Discover great items to add to your cart!</p>
            <a href="{% url 'user_side:product_list' %}" class="btn uren-add_cart">Start Shopping</a>
        </div>
    {% endif %}
</div>






<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<script>
$(document).ready(function() {
    toastr.options = {
        "closeButton": true,
        "debug": false,
        "newestOnTop": false,
        "progressBar": true,
        "positionClass": "toast-bottom-right",
        "preventDuplicates": true,
        "onclick": null,
        "showDuration": "300",
        "hideDuration": "1000",
        "timeOut": "5000",
        "extendedTimeOut": "1000",
        "showEasing": "swing",
        "hideEasing": "linear",
        "showMethod": "fadeIn",
        "hideMethod": "fadeOut"
    }

    function formatNumber(num) {
        return num.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,')
    }

    function updateCartItem(quantityControl) {
        var productId = quantityControl.data('product-id');
        var quantity = parseInt(quantityControl.find('.qty-input').val());
        
        $.ajax({
            url: '{% url "user_profile:update_cart_quantity" %}',
            method: 'POST',
            data: {
                'product_id': productId,
                'quantity': quantity,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if(response.success) {
                    $('.total-price').text(formatNumber(response.total_price));
                    $('.saved-amount').text(formatNumber(response.saved_price));
                    toastr.success('Cart updated successfully');
                } else {
                    toastr.error('Failed to update cart');
                }
            },
            error: function(xhr, errmsg, err) {
                console.log(xhr.status + ": " + xhr.responseText);
                toastr.error('An error occurred while updating the cart');
            }
        });
    }

    $('.plus-btn').click(function() {
        var quantityControl = $(this).closest('.quantity-control');
        var input = quantityControl.find('.qty-input');
        var currentVal = parseInt(input.val());
        var maxVal = parseInt(input.attr('max'));
        
        if (!isNaN(currentVal) && currentVal < maxVal) {
            input.val(currentVal + 1);
            updateCartItem(quantityControl);
        } else {
            toastr.warning('Reached maximum stock count');
        }
    });

    $('.minus-btn').click(function() {
        var quantityControl = $(this).closest('.quantity-control');
        var input = quantityControl.find('.qty-input');
        var currentVal = parseInt(input.val());
        
        if (!isNaN(currentVal) && currentVal > 1) {
            input.val(currentVal - 1);
            updateCartItem(quantityControl);
        }
    });

    $('.qty-input').change(function() {
        var quantityControl = $(this).closest('.quantity-control');
        var input = $(this);
        var newVal = parseInt(input.val());
        var maxVal = parseInt(input.attr('max'));
        
        if (isNaN(newVal) || newVal < 1) {
            input.val(1);
            toastr.warning('Quantity adjusted to minimum');
        } else if (newVal > maxVal) {
            input.val(maxVal);
            toastr.warning('Adjusted to maximum stock count');
        }
        
        updateCartItem(quantityControl);
    });
});
</script>

{% endblock %}